#include <reg52.h> 
#define uchar unsigned char 
#define uint unsigned int //sbit duan=P3^6; 
sbit key1=P3^2;//按 key1可暂停歌曲
sbit key2=P3^3;//按 key2可切换歌曲
sbit fm=P1^5;//蜂鸣器连续的 IO 口
sbit KK=P2^0; //点亮一个数码管
uchar count2=0;//歌曲标志
uchar timeh,timel,i; 
/***********************************************************/ 
uchar code DSY_table[]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80, //0~8 
0x90,0x88,0x83,0xc6,0xa1,0x86,0x8e,0x8f}; 
//9,A~F 
uint code tone_delay_table[]={ 64021,64103,64260,64400,64524,64580,64684, 
64777,64820,64898,64968,65030,65058,65110,65157,65178}; // 各音符对应的延时
uchar keyno; //定义按键得到的初值
void delay_ms(uchar x) //延时子函数
{ uchar i; 
while(x--) 
for(i=0;i<120;i++); 
} 
void keys_scan() //键盘扫描子函数
{ uchar tmp,k; 
P1=0x0f; //高四位置 0 ，放入四行
delay_ms(2); 
//按键后 00001111将变成 0000xxxx,x 中 1 个为 0，3 个仍为 1 
//下面的异或操作会把 3个 1 变成 0，唯一的 0 变成 1 
tmp=P1^0x0f; //判断按键发生于 0~3 列中的哪一列
switch(tmp) 
{case 1:k=0; break; 
case 2:k=1; break; 
case 4:k=2; break; 
case 8:k=3; break; 
default:return;//无按键按下
} 
P1=0xf0; //低四位置 0，放入四列
delay_ms(2); 
tmp=(P1>>4)^0x0f; //按键后 11110000将变成 xxxx0000,x 中 1 个为 0，3 个
//仍为 1，将高四位移至低四位，并将其中唯一的 0 变成 1，其余为 0 
//对 0~3 行分别附加其初始值 0，4，8，12 
switch(tmp) 
{case 1:k+=0; break; 
case 2:k+=4; break; 
case 4:k+=8; break; 
case 8:k+=12; break; 
default:return;} 
keyno=k; //将 k 的值赋给 keyno 由数码管输出
} 
//--------------------------- 简谱--------------------------------------- 
//编程规则 :字节高位是简谱 ,低位是持续时间 , 
//代表多少个十六分音符
//1-7 代表中央 C 调,8-E 代表高八度 ,0 代表停顿
//最后的 0 是结束标志
uchar code qnzl[]={ //千年之恋
0x12,0x22,0x34,0x84,0x74,0x54,0x38,0x42,0x32,0x22,0x42,0x34,0x84,0x72,0x82,0x94,0xA8,0x08, 0x32,0x31,0x21,0x32,0x52,0x32,0x31,0x21,0x32,0x62, 
0x32,0x31,0x21,0x32,0x82,0x71,0x81,0x71,0x51,0x32,0x22, 
0x32,0x31,0x21,0x32,0x52,0x32,0x31,0x21,0x32,0x62, 
0x32,0x31,0x21,0x32,0x83,0x82,0x71,0x72,0x02, 
0x63,0xA1,0xA2,0x62,0x92,0x82,0x52, 
0x31,0x51,0x63,0x51,0x63,0x51,0x63,0x51,0x62,0x82,0x7C,0x02, 
0x61,0x71,0x82,0x71,0x62,0xA2,0x71,0x76, 
0x61,0x71,0x82,0x71,0x62,0x52,0x31,0x36, 
0x61,0x71,0x82,0x71,0x62,0xA3,0x73,0x62,0x53, 
0x42,0x63,0x83,0x83,0x91,0x91, 
0x61,0x71,0x82,0x71,0x62,0x0A2,0x71,0x76, 
0x61,0x71,0x82,0x71,0x62,0x52,0x31,0x36, 
0x61,0x71,0x82,0x71,0x62,0xA3,0x73,0x62,0x53, 
0x42,0x82,0x88,0x02,0x74,0x93,0x89,
0xff//结束标志
}; 
uchar code jmszl[]={ //寂寞沙洲冷
0x12,0x12,0x22,0x32,0x31,0x22,0x21,0x22, 
0x21,0x31,0x51,0x52,0x31,0x52,0x61,0x15,0x14, 
0x51,0x52,0x31,0x52,0x62,0x13,0x11,0x13,0x32,0x28,0x08,0x28, 
0x31,0x32,0x31,0x32,0x11,0x21,0x51,0x52,0x51,0x52, 
0x51,0x51,0x31,0x32,0x31,0x32,0x81,0x72,0x63, 
0x62,0x71,0x81,0x72,0x61,0x61,0x52,0x31,0x21,0x32,0x51,0x54, 
0x22,0x12,0x11,0x12,0x11,0x12,0x12,0x14,0x26,0x32,0x26, 
0x32,0x61,0x51,0x51,0x31,0x31,0x21,0x31,0x51,0x61,0x51,0x31,0x51, 
0x02,0x32,0x81,0x81,0x81,0x81,0x62,0x52,0x34, 
0x31,0x81,0x81,0x81,0x61,0x91,0x82, 
0x51,0x51,0x51,0x51,0x31,0x61,0x53, 
0x21,0x11,0x21,0x11,0x22,0x11,0x21,0x26, 
0x32,0x61,0x51,0x51,0x31,0x31,0x21,0x31,0x51,0x61,0x51,0x31,0x51,0x52, 
0x31,0x31,0x81,0x81,0x81,0x61,0x91,0x81,0x61,0x31,0x56, 0x32,0x32,0x81,0x81,0x81,0x81,0x91,0x81,0x61,0x81,0x61,0x51,0x31,0x51,0x34, 
0x21,0x31,0x51,0x31,0x21,0x11,0x61,0x21,0x16, 
0xff// 结束标志
}; 
uchar code qizige[]={ //七子之歌
0x54,0x32,0x52,0x32,0x54,0x62,0x52,0x32,0x62,0x54, 
0x14,0x12,0x22,0x34,0x52,0x32,0x02,0x32,0x58, 
0x52,0x52,0x62,0x52,0x32,0x54,0x52,0x62,0x52,0x82,0x62,0x58, 
0x14,0x52,0x32,0x22,0x12,0x24,0x32,0x54,0x2,0x22,0x34,0x1f,0x18, 
0x04,0x54,0xa4,0x92,0x81,0x62,0x52,0x54,0x62,0x64,0x52,0x62,0x81,0xa2,0x82,0x9c, 
0x02,0x52,0xa4,0x92,0x81,0x62,0x52,0x54,0x62,0x64,0x52,0x64,0xa2,0x92,0x9f, 
0xa4,0x92,0x81,0x62,0x52,0x54,0x84,0x62,0x52,0x32,0x22,0x14, 
0x04,0x22,0x32,0x58,0x58,0x04,0x52,0x62,0x8f, 
0xff// 结束标志
}; 
uchar code ganen[]={ //感恩的心
0x12,0x14,0x22,0x32,0x54,0x32,0x84,0x72,0x62,0x54, 
0x02,0x62,0x62,0x52,0x54,0x12,0x22,0x32,0x28, 
0x12,0x14,0x22,0x32,0x54,0x32,0x84,0x92,0x82,0x54, 
0x32,0x24,0x21,0x61,0x54,0x22,0x32,0x12,0x18, 
0x22,0x24,0x12,0x24,0x11,0x21,0x34,0x32,0x21,0x31,0x34, 
0x12,0x22,0x22,0x22,0x11,0x21,0x22,0x64,0x52,0x52,0x32,0x38, 
0x31,0x52,0x51,0x52,0x31,0x51,0x58,0x31,0x82,0x81,0x82,0x31,0x61,0x68, 
0x62,0x62,0x62,0x51,0x61,0x64,0x61,0x82,0x61,0x9c, 
0x52,0xa4,0x92,0xa4,0x32,0x84,0x72,0x64,0x62,0x94,0x82,0x94, 
0x61,0x81,0x92,0x91,0x91,0x92,0x81,0xa1,0xa2,0x92,0x94, 
0x52,0xa4,0x92,0xa4,0x32,0x84,0x72,0x64, 
0x52,0x62,0x81,0x81,0x82,0x92,0xa2,0x94,0x82,0x72,0x82,0x88, 
0xff// 结束标志
}; 
//---------------------------- 简谱音调对应的定时器初值 --------------------------- 

uchar code cuzhi[]={ 
0xff,0xff,// 占位
0xFC,0x8E,//中央 C 调 1-7 
0xFC,0xED, 
0xFD,0x43, 
0xFD,0x6A, 
0xFD,0xB3, 
0xFD,0xF3, 
0xFE,0x2D, 
0xFE,0x47, //高八度 1-7 
0xFE,0x76, 
0xFE,0xA1, 
0xFE,0xC7, 
0xFE,0xD9, 
0xFE,0xF9, 
0xFF,0x16 
}; 
void delay1(uint z); //延时 1MS 
void delay(uint z); //延时 165MS,即十六分音符
void song(); 
void beep();//蜂鸣器响一下
void main() 
{ 
P0=0xbf; 
KK=0; count2=0; //不唱歌
EA=1;//开总中断
EX0=1;//开外部中断 0 
IT0=1;//外部中断 0 下降沿触发方式
EX1=1;//开外部中断 1 
IT1=1;//外部中断 1 下降沿触发方式
TMOD=0x01;// 定时器 0 工作在方式 1 
TH0=0; 
TL0=0; 
ET0=1; 
while(1) 
{ 
if(count2!=0) 
{ 
song(); 
delay1(1000); 
} 
if(count2==0) 
{ keys_scan(); //矩阵键盘无限扫描
P1=0xf0; 
if(P1!=0xf0) 
{ 
P0=DSY_table[keyno]; 
TR0=1; 
} 
if(P1==0XF0) 
{TR0=0; 
} 
delay_ms(2); } 
} 
} 
void int0() interrupt 0 
{ 
EA=0;//关总中断
delay1(500);//消抖
if(key1==0) 
{ 
count2=0; //暂停音乐
TR0=0; 
} 
EA=1; 
} 
void int1() interrupt 2 
{ 
TR0 = 0; 
delay1(500);//去抖
if(key2==0) 
{ 
i=0;//从头开始唱
count2++; 
TR0=~TR0; 
if(count2==5) 
count2=0; 
} } 
//中断
void timer0() interrupt 1 //用于产生各种音调
{ 
if(count2==0) 
{ 
TH0=tone_delay_table[keyno]/256; 
TL0=tone_delay_table[keyno]%256; 
fm=~fm; 
} 
if(count2!=0) 
{ 
TH0=timeh; 
TL0=timel; 
fm=~fm; 
} 
} 
void song() 
{ 
uint temp; 
uchar jp;//jp 是简谱
i=0; 
while(1) 
{ if(count2==0) 
{ 
break; 
} 
if(count2==1) // 选曲
  temp=jmszl[i]; 
if(count2==2) 
	temp=qnzl[i]; 
if(count2==3) 
  temp=qizige[i]; 
if(count2==4) 
  temp=ganen[i]; 
if(temp==0xff) 
  break; 
jp=temp/16; //取数的高 4 位
if(jp!=0) 
{ 
timeh=cuzhi[jp*2]; 
timel=cuzhi[jp*2+1]; 
} 
else 
{ 
TR0=0; 
fm=1;//关蜂鸣器
} 
delay(temp%16); //取数的低 4 位
TR0=0; //唱完一个音停 10MS 
fm=1; 
delay1(10); 
TR0=1; 
i++; 
} 
TR0=0; 
fm=1; 
} 
void delay(uint z) //延时 165MS,即十六分音符
{ uint x,y; for(x=z;x>0;x--) 
for(y=19000;y>0;y--); 
} 
void delay1(uint z) //延时 1MS 
{ uint x,y; 
for(x=z;x>0;x--) 
for(y=112;y>0;y--); 
} 
void beep() //蜂鸣器响一下
{ uchar i; 
for(i=0;i<50;i++) 
{ fm=~fm; 
delay1(1); 
} 
fm=1; 
}